<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Add to Cart form submission via AJAX
    $("#cart-form").on("submit", function(e) {
        e.preventDefault();
        let formData = new FormData(this);

        $.ajax({
            url: "{% url 'add-to-cart' %}",
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                "X-CSRFToken": csrftoken
            },
            success: function(res) {
                if (res.status === "success") {
                    alertify.success(res.message);
                    $("#cart-form")[0].reset();  
                    $("#cart-count").text(res.cart_count);
                    $("#cart-total").html('Your Cart:<br>$' + res.total_price);
                    console.log(res);
                } else {
                    alertify.error(res.message);
                    console.log(res);
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error:", error);
                alert("Something went wrong. Please try again.");
            }
        });
    });


    // Quantity change (using event delegation)
    $(document).on('click', '.qty-btn', function () {
        let parent = $(this).closest('.cart-item');
        let cartId = parent.data('id');
        let action = $(this).data('action');

        $.ajax({
            url: "{% url 'qty-inc-dec' %}",
            type: "POST",
            data: {
                cart_id: cartId,
                action: action,
                csrfmiddlewaretoken: csrftoken
            },
            success: function (res) {
                if (res.status === 'success') {
                    console.log(res);
                    parent.find('.quantity').text(res.quantity);
                    parent.find('.subtotal').text(parseFloat(res.item_total).toFixed(2));
                    let totalPrice = parseFloat(res.cart_total).toFixed(2);
                    $("#cart-total").html('Your Cart:<br>$' + totalPrice);
                    $('#grand-total').text(parseFloat(res.cart_total).toFixed(2));
                    alertify.success(res.message);
                } else {
                    alertify.error(res.message);
                    console.log(res);
                }
            },
            error: function (xhr, status, error) {
                console.log("Error:", error);
            }
        });
    });

    // Remove item
    $(document).on('click', '.remove-item', function () {
        let btn = $(this);
        let parent = btn.closest('.cart-item');
        let cartId = parent.data('id');

        $.ajax({
            url: "{% url 'cart-remove-item' %}",
            type: "POST",
            data: {
                cart_id: cartId,
                csrfmiddlewaretoken: csrftoken
            },
            success: function (res) {
                if (res.status === 'success') {
                    // Remove item row
                    parent.remove();
                    console.log(res);
                    $("#cart-count").text(res.cart_count);
                    // Update totals
                    let totalPrice = parseFloat(res.total_price).toFixed(2);
                    $("#cart-total").html('Your Cart:<br>$' + totalPrice);
                    $("#grand-total").text(totalPrice);

                    // Show success message
                    alertify.success(res.message);
                } else {
                    alertify.error(res.message);
                    console.log(res);
                }
            },
            error: function () {
                alert("Failed to remove item!");
            }
        });
    });
</script>
