{% load static %}
<script src="{% static 'assets/js/vendor/jquery.js' %}"></script>
<script>
// static/js/product-ajax.js
$(document).ready(function () {
    // ================== CSRF TOKEN ==================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // ================== SIZE CHANGE ==================
    $('#size_select').on('change', function () {
        let size_id = $(this).val();
        let product_id = $('#product_id').val(); 

        $.ajax({
            url: '/get-variant-by-size/',  // Django URL
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                size_id: size_id,
                product_id: product_id,
            },
            success: function (res) {
                console.log(res);
                $("#variant_id").val(res.variant_id);
                $('#colors-show').html(res.rendered_colors);
                $("#product-price").text(res.variant_price || '0');
                $("#display-color").text(res.color || '');
                $("#display-size").text(res.size || '');
                $("#variant-image").attr("src", res.variant_image);
                $("#display-variant-stock").text('Availability (Variant Stock): ' + (res.available_stock || 0));
                $("#sku").text(res.sku);

                bindColorEvents(); // color radio button bind
            },
            error: function (xhr) {
                console.error(xhr.responseText);
            }
        });
    });

    // ================== COLOR SELECT ==================
    function bindColorEvents() {
        $('input[name="variant_radio"]').off('change').on('change', function () {
            let variant_id = $(this).val();

            $.ajax({
                url: '/get-variant-by-color/',
                type: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                data: {
                    variant_id: variant_id
                },
                success: function (res) {
                    console.log(res);
                    $("#variant_id").val(res.variant_id);
                    $("#product-price").text(res.variant_price || '0');
                    $("#display-color").text(res.color || '');
                    $("#display-size").text(res.size || '');
                    $("#variant-image").attr("src", res.variant_image);
                    $("#sku").text(res.sku);
                    $("#display-variant-stock").text('Availability (Variant Stock): ' + (res.available_stock || 0));
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                }
            });
        });
    }

    // Initial color binding
    bindColorEvents();

    // ================== REVIEW FORM ==================
    $('#review-form').on('submit', function (e) {
        e.preventDefault();

        let form = $(this);
        let data = new FormData(this);

        // Validation
        if (!$('input[name="rating"]:checked').length) {
            alertify.error("Please select a rating");
            return;
        }
        if (!$('#subject').val().trim() || !$('#comment').val().trim()) {
            alertify.error("Please fill in subject and comment");
            return;
        }

        $.ajax({
            url: '/product-review/',  // Django URL
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: data,
            processData: false,
            contentType: false,
            success: function (res) {
                if (res.status === 'success') {
                    alertify.success(res.message);
                    form[0].reset();
                    $('#review_count').text('Reviews (' + res.review_count + ')');
                    $('#reviews-items').prepend(res.review_html);
                } else {
                    alertify.error(res.message);
                }
            },
            error: function (xhr) {
                alertify.error("Something went wrong.");
                console.error(xhr.responseText);
            }
        });
    });

});

    
</script> 