{% extends 'base.html' %}
{% load static %}

{% block title %}Product details{% endblock title %}

{% block main_content %}

<!-- breadcrumb__area-start -->
<section class="breadcrumb__area box-plr-75">
    <div class="container">
        <div class="row">
            <div class="col-xxl-12">
                <div class="breadcrumb__wrapper">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Shop</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- breadcrumb__area-end -->

<!-- product-details-start -->
<div class="product-details">
    <div class="container">
        <div class="row">

            <!-- Product Images -->
            <div class="col-xl-6">
                <div class="product__details-nav d-sm-flex align-items-start">
                    {% if product.images.exists %}
                        <ul class="nav nav-tabs flex-sm-column justify-content-between" id="productThumbTab" role="tablist">
                            {% for img in product.images.all %}
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {% if forloop.first %}active{% endif %}" 
                                            id="thumb{{ img.id }}-tab" 
                                            data-bs-toggle="tab" 
                                            data-bs-target="#thumb{{ img.id }}" 
                                            type="button" role="tab" 
                                            aria-controls="thumb{{ img.id }}" 
                                            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                                        <img src="{{ img.image.url }}" 
                                             alt="{{ product.title|title }}" 
                                             class="img-fluid" 
                                             style="width:100px; height:150px; object-fit:cover;">
                                    </button>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}

                    <div class="product__details-thumb">
                        <div class="tab-content" id="productThumbContent">
                            {% if product.images.exists %}
                                {% for img in product.images.all %}
                                    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                                         id="thumb{{ img.id }}" 
                                         role="tabpanel" 
                                         aria-labelledby="thumb{{ img.id }}-tab">
                                        <div class="product__details-nav-thumb w-img">
                                            <img src="{{ img.image.url }}" 
                                                 alt="{{ product.title|title }}" 
                                                 style="width: 350px; height: 500px; object-fit:cover;">
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                </div>
            </div>

            <!-- Product Details Content -->
            <div class="col-xl-6">
                <div class="product__details-content">
                    <h6>{{ product.title|title }}</h6>

                    <!-- Rating -->
                    <div class="pd-rating mb-10">
                        <ul class="rating">
                            {% for i in "12345" %}
                                <i class="fa {% if product.avg_rate >= i|add:0 %}fa-star{% else %}fa-star-o{% endif %}" style="color: #FFD700;"></i>
                            {% endfor %}
                        </ul>
                        <span>({{ product.reviews.count }} review{{ product.reviews.count|pluralize }})</span>
                    </div>

                    <!-- Price -->
                    <div class="price mb-10">
                        <span>
                            $ <span id="product-price">{{ product.sale_price }}</span>
                            <del class="text-danger">
                                {% if product.old_price %} $ {{ product.old_price }} {% endif %}
                            </del>
                        </span>
                    </div>

                    <!-- Features -->
                    <div class="features-des mb-20 mt-10">
                        <ul>
                            <li><span><i class="fas fa-circle"></i> Discount: {{ product.discount_percent }} %.</span></li>
                            <li><span><i class="fas fa-circle"></i> Category: {{ product.category.title|title }}.</span></li>
                            <li><span><i class="fas fa-circle"></i> Brand: {{ product.brand.title|title }}.</span></li>
                        </ul>
                    </div>

                    <!-- Stock -->
                    <div class="product-stock mb-20">
                        <h5>Availability: <span>{{ product.available_stock }}</span></h5>
                    </div>

                    <!-- Variants Section -->
                    {% if product.variant == "color-size" %}
                        <!-- Color Options -->
                        <div class="details-meta colors">
                            <label>Colors:</label>
                            <div id="colors-show" class="color">
                                {% for color in variants %}
                                    <label class="custom-control custom-radio custom-control-inline">
                                        <input type="radio"
                                                name="variant_id"
                                                class="variant-color"
                                                value="{{ color.id }}"
                                                {% if forloop.first %}checked{% endif %}>
                                        <span>{{ color.color.title }}</span><br>
                                        <img src="{{ color.image_url }}" 
                                                alt="{{ color.color.title }}" 
                                                style="width:30px; height:30px;">
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Size Options -->
                        <div class="details-meta sizes mt-15">
                            <label>Sizes:</label>
                            <select name="size" id="size-select" class="size">
                                {% for size in variants %}
                                    <option value="{{ size.size.id }}">{{ size.size.title }}</option>
                                {% endfor %}
                            </select>
                        </div>

                    {% elif product.variant == "color" %}
                        <div class="details-meta colors">
                            <label>Colors:</label>
                            <div id="colors-show" class="color">
                                {% for color in variants %}
                                    <label class="custom-control custom-radio custom-control-inline">
                                        <input type="radio"
                                                name="variant_id"
                                                class="variant-color"
                                                value="{{ color.id }}"
                                                {% if forloop.first %}checked{% endif %}>
                                        <span>{{ color.color.title }}</span><br>
                                        <img src="{{ color.image_url }}" 
                                                alt="{{ color.color.title }}" 
                                                style="width:30px; height:30px;">
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                    {% elif product.variant == "size" %}
                        <div class="details-meta sizes">
                            <label>Sizes:</label>
                            <select name="size" id="size-select" class="size">
                                {% for size in variants %}
                                    <option value="{{ size.size.id }}">{{ size.size.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endif %}
                    <!-- End Variants Section -->

                    {% if product.variant %}
                    <!-- Add to Cart Form -->
                    <form method="POST" action="{% url 'add-to-cart' %}" id="cart-form">
                        {% csrf_token %}
                        <input type="hidden" name="product_slug" value="{{ product.slug }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" name="variant_id" id="variant_id" value="{{ variants.id }}">
                        
                        <div class="cart-option mb-15">
                            <div class="product-quantity mr-20">
                                <input type="number" name="quantity" id="quantity"
                                value="1" min="1" max="{{ variant.available_stock }}">
                            </div>
                            <button type="submit" class="cart-btn">Add to Cart</button>
                        </div>
                    </form>
                    {% else %}
                    <!-- Add to Cart Form -->
                    <form method="POST" action="{% url 'add-to-cart' %}" id="cart-form">
                        {% csrf_token %}
                        <input type="hidden" name="product_slug" value="{{ product.slug }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">

                        <div class="cart-option mb-15">
                            <div class="product-quantity mr-20">
                                <input type="number" name="quantity" id="quantity"
                                value="1" min="1" max="{{ product.available_stock }}">
                            </div>
                            <button type="submit" class="cart-btn">Add to Cart</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>
<!-- product-details-end -->

<!-- AJAX for variant changes -->
<script src="{% static 'assets/js/vendor/jquery.js' %}"></script>
<script>
$(document).ready(function(){
    // Size change → update colors
    $('#size-select').change(function(){
        var size_id = $(this).val();
        var product_id = "{{ product.id }}";

        $.ajax({
            type: "POST",
            url: "{% url 'get-product-variant' %}",
            data: {
                'action': 'post',
                'size': size_id,
                'product_id': product_id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(res){
                console.log(res);
                $('#colors-show').html(res.rendered_table); 

                $('#variant_id').val(res.variant_id); 
                
                $('#product-price').text(res.price);
                $('.product-stock h5 span').text(res.stock);
            }
        });
    });

    // Color change → update hidden variant_id
    $(document).on('change', '.variant-color', function(){
        $('#variant_id').val($(this).val());
    });
});
</script>

{% endblock main_content %}
